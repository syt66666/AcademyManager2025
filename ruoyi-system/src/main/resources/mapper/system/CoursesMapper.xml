<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.CoursesMapper">

    <resultMap type="Courses" id="CoursesResult">
        <result property="courseId"    column="course_id"    />
        <result property="courseName"    column="course_name"    />
        <result property="courseType"    column="course_type"    />
        <result property="courseLocation"    column="course_location"    />
        <result property="courseStart"    column="course_start"    />
        <result property="courseDeadline"    column="course_deadline"    />
        <result property="startTime"    column="start_time"    />
        <result property="endTime"    column="end_time"    />
        <result property="courseTotalCapacity"    column="course_total_capacity"    />
        <result property="courseCapacity"    column="course_capacity"    />
        <result property="courseDescription"    column="course_description"    />
        <result property="pictureUrl"    column="picture_url"    />
        <result property="status"    column="status"    />
        <result property="createdAt"    column="created_at"    />
        <result property="organizer"    column="organizer"    />
        <result property="notes"    column="notes"    />
        <result property="version"    column="version"    />
        <result property="courseCredit"    column="course_credit"    />
        <result property="courseCategory"    column="course_category"    />
    </resultMap>

    <sql id="selectCoursesVo">
        select course_id, course_name, course_type, course_location, course_start, course_deadline, start_time, end_time, course_total_capacity, course_capacity, course_description, picture_url, status, created_at, organizer, notes, version, course_credit, course_category from courses
    </sql>

    <select id="selectCoursesList" parameterType="Courses" resultMap="CoursesResult">
        <include refid="selectCoursesVo"/>
        <where>
            <if test="courseName != null  and courseName != ''"> and course_name like concat('%', #{courseName}, '%')</if>
            <if test="courseType != null "> and course_type = #{courseType}</if>
            <if test="courseLocation != null  and courseLocation != ''"> and course_location = #{courseLocation}</if>
            <if test="courseStart != null "> and course_start = #{courseStart}</if>
            <if test="courseDeadline != null "> and course_deadline = #{courseDeadline}</if>
            <if test="startTime != null "> and start_time = #{startTime}</if>
            <if test="endTime != null "> and end_time = #{endTime}</if>
            <if test="courseTotalCapacity != null "> and course_total_capacity = #{courseTotalCapacity}</if>
            <if test="courseCapacity != null "> and course_capacity = #{courseCapacity}</if>
            <if test="courseDescription != null  and courseDescription != ''"> and course_description = #{courseDescription}</if>
            <if test="pictureUrl != null  and pictureUrl != ''"> and picture_url = #{pictureUrl}</if>
            <if test="status != null  and status != ''"> and status = #{status}</if>
            <if test="createdAt != null "> and created_at = #{createdAt}</if>
            <if test="organizer != null  and organizer != ''"> and organizer = #{organizer}</if>
            <if test="notes != null  and notes != ''"> and notes = #{notes}</if>
            <if test="version != null "> and version = #{version}</if>
            <if test="courseCredit != null "> and course_credit = #{courseCredit}</if>
            <if test="courseCategory != null  and courseCategory != ''"> and course_category = #{courseCategory}</if>
        </where>
    </select>

    <select id="selectCoursesByCourseId" parameterType="Long" resultMap="CoursesResult">
        <include refid="selectCoursesVo"/>
        where course_id = #{courseId}
    </select>

    <insert id="insertCourses" parameterType="Courses" useGeneratedKeys="true" keyProperty="courseId">
        insert into courses
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="courseName != null and courseName != ''">course_name,</if>
            <if test="courseType != null">course_type,</if>
            <if test="courseLocation != null and courseLocation != ''">course_location,</if>
            <if test="courseStart != null">course_start,</if>
            <if test="courseDeadline != null">course_deadline,</if>
            <if test="startTime != null">start_time,</if>
            <if test="endTime != null">end_time,</if>
            <if test="courseTotalCapacity != null">course_total_capacity,</if>
            <if test="courseCapacity != null">course_capacity,</if>
            <if test="courseDescription != null">course_description,</if>
            <if test="pictureUrl != null">picture_url,</if>
            <if test="status != null">status,</if>
            <if test="createdAt != null">created_at,</if>
            <if test="organizer != null and organizer != ''">organizer,</if>
            <if test="notes != null">notes,</if>
            <if test="version != null">version,</if>
            <if test="courseCredit != null">course_credit,</if>
            <if test="courseCategory != null">course_category,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="courseName != null and courseName != ''">#{courseName},</if>
            <if test="courseType != null">#{courseType},</if>
            <if test="courseLocation != null and courseLocation != ''">#{courseLocation},</if>
            <if test="courseStart != null">#{courseStart},</if>
            <if test="courseDeadline != null">#{courseDeadline},</if>
            <if test="startTime != null">#{startTime},</if>
            <if test="endTime != null">#{endTime},</if>
            <if test="courseTotalCapacity != null">#{courseTotalCapacity},</if>
            <if test="courseCapacity != null">#{courseCapacity},</if>
            <if test="courseDescription != null">#{courseDescription},</if>
            <if test="pictureUrl != null">#{pictureUrl},</if>
            <if test="status != null">#{status},</if>
            <if test="createdAt != null">#{createdAt},</if>
            <if test="organizer != null and organizer != ''">#{organizer},</if>
            <if test="notes != null">#{notes},</if>
            <if test="version != null">#{version},</if>
            <if test="courseCredit != null">#{courseCredit},</if>
            <if test="courseCategory != null">#{courseCategory},</if>
        </trim>
    </insert>

    <update id="updateCourses" parameterType="Courses">
        update courses
        <trim prefix="SET" suffixOverrides=",">
            <if test="courseName != null and courseName != ''">course_name = #{courseName},</if>
            <if test="courseType != null">course_type = #{courseType},</if>
            <if test="courseLocation != null and courseLocation != ''">course_location = #{courseLocation},</if>
            <if test="courseStart != null">course_start = #{courseStart},</if>
            <if test="courseDeadline != null">course_deadline = #{courseDeadline},</if>
            <if test="startTime != null">start_time = #{startTime},</if>
            <if test="endTime != null">end_time = #{endTime},</if>
            <if test="courseTotalCapacity != null">course_total_capacity = #{courseTotalCapacity},</if>
            <if test="courseCapacity != null">course_capacity = #{courseCapacity},</if>
            <if test="courseDescription != null">course_description = #{courseDescription},</if>
            <if test="pictureUrl != null">picture_url = #{pictureUrl},</if>
            <if test="status != null">status = #{status},</if>
            <if test="createdAt != null">created_at = #{createdAt},</if>
            <if test="organizer != null and organizer != ''">organizer = #{organizer},</if>
            <if test="notes != null">notes = #{notes},</if>
            <if test="version != null">version = #{version},</if>
            <if test="courseCredit != null">course_credit = #{courseCredit},</if>
            <if test="courseCategory != null">course_category = #{courseCategory},</if>
        </trim>
        where course_id = #{courseId}
    </update>

    <delete id="deleteCoursesByCourseId" parameterType="Long">
        delete from courses where course_id = #{courseId}
    </delete>

    <delete id="deleteCoursesByCourseIds" parameterType="String">
        delete from courses where course_id in
        <foreach item="courseId" collection="array" open="(" separator="," close=")">
            #{courseId}
        </foreach>
    </delete>

    <update id="decreaseCapacity">
        UPDATE courses 
        SET course_capacity = GREATEST(0, course_capacity - 1),
            version = version + 1
        WHERE course_id = #{courseId} 
          AND version = #{version}
          AND course_capacity &gt; 0
    </update>

    <update id="increaseCapacity">
        UPDATE courses 
        SET course_capacity = LEAST(course_total_capacity, course_capacity + 1),
            version = version + 1
        WHERE course_id = #{courseId} 
          AND version = #{version}
          AND course_capacity &lt; course_total_capacity
    </update>
</mapper>