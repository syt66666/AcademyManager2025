<template>
  <div class="container">
    <div class="main-container">
      <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
      <div class="nav">
        <div class="nav-content">
          <h2>
            <span class="score-icon">üìù</span>
            ËÆ≤Â∫ßÊä•ÂëäÁÆ°ÁêÜ
            <span class="current-semester">{{ activeSemester }} ËÆ≤Â∫ßËÆ∞ÂΩï</span>
          </h2>
          <el-button
            type="primary"
            class="add-button"
            @click="addNewCard"
            icon="el-icon-plus"
          >Êñ∞Â¢ûÊä•Âëä
          </el-button>
        </div>
      </div>

      <!-- Ë°®Ê†ºÂå∫Âüü -->
      <div class="report-table-card">
        <el-table
          :data="records"
          class="optimized-table"
          :header-cell-style="headerStyle"
          highlight-current-row
        >
          <!-- Â∫èÂè∑Âàó -->
          <el-table-column type="index" label="Â∫èÂè∑" width="80" align="center">
            <template v-slot="scope">
              <span class="index-badge">
                {{ (currentPage - 1) * pageSize + scope.$index + 1 }}
              </span>
            </template>
          </el-table-column>

          <!-- ËÆ≤Â∫ßÈ¢òÁõÆ -->
          <el-table-column prop="reportTitle" label="ËÆ≤Â∫ßÈ¢òÁõÆ" width="120">
            <template v-slot="scope">
              <div class="lecture-name">
                <i class="el-icon-notebook-2 name-icon"></i>
                <span class="name-text">{{ scope.row.reportTitle }}</span>
              </div>
            </template>
          </el-table-column>

          <!-- ËÆ≤Â∏àÂßìÂêç -->
          <el-table-column prop="reporter" label="ËÆ≤Â∏àÂßìÂêç" width="120" align="center">
            <template v-slot="scope">
              <el-tag effect="light" class="reporter-tag">
                {{ scope.row.reporter }}
              </el-tag>
            </template>
          </el-table-column>

          <!-- ËÆ≤Â∫ßÂú∞ÁÇπ -->
          <el-table-column prop="reportLocation" label="ËÆ≤Â∫ßÂú∞ÁÇπ" width="120" align="center">
            <template v-slot="scope">
              <el-tag effect="light" class="level-tag">
                {{ scope.row.reportLocation }}
              </el-tag>
            </template>
          </el-table-column>

          <!-- ËÆ≤Â∫ßÈìæÊé• -->
          <el-table-column prop="reportLink" label="ËÆ≤Â∫ßÈìæÊé•" width="120" align="center">
            <template v-slot="scope">
              <el-tag
                :effect="scope.row.reportLink ? 'light' : 'plain'"
                :class="!scope.row.reportLink ? 'disabled-tag' : ''"
                class="location-tag"
              >
                <a
                  :href="scope.row.reportLink || 'javascript:void(0)'"
                  :class="{ 'disabled-link': !scope.row.reportLink }"
                  class="link-style"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  ÁÇπÂáªÊü•Áúã
                </a>
              </el-tag>
            </template>
          </el-table-column>

          <!-- ËÆ≤Â∫ßÊó∂Èó¥ -->
          <el-table-column prop="reportDate" label="ËÆ≤Â∫ßÊó∂Èó¥" width="120" align="center">
            <template v-slot="scope">
              <span class="time-display">
                {{ formatDate(scope.row.reportDate) }}
              </span>
            </template>
          </el-table-column>

          <!-- ÊÄªÁªìÊñáÊ°£ -->
          <el-table-column label="ÊÄªÁªìÊñáÊ°£" width="160" align="center">
            <template v-slot="scope">
              <el-dropdown
                trigger="click"
                @command="handleDocCommand"
                :disabled="!scope.row.reportFeeling"
              >
                <el-button
                  type="primary"
                  size="mini"
                  plain
                  :disabled="!scope.row.reportFeeling"
                >
                  <i class="el-icon-document"></i> ÊñáÊ°£Êìç‰Ωú
                </el-button>
                <el-dropdown-menu slot="dropdown">
                  <el-dropdown-item
                    :command="{ action: 'preview', row: scope.row }"
                  >È¢ÑËßà
                  </el-dropdown-item>
                  <el-dropdown-item
                    :command="{ action: 'download', row: scope.row }"
                  >‰∏ãËΩΩ
                  </el-dropdown-item>
                </el-dropdown-menu>
              </el-dropdown>
            </template>
          </el-table-column>

          <!-- Áé∞Âú∫ÂõæÁâá -->
          <el-table-column label="Áé∞Âú∫ÂõæÁâá" width="140" align="center">
            <template v-slot="scope">
              <el-dropdown trigger="click" @command="handleFileCommand" :disabled="!scope.row.reportPicture || scope.row.reportPicture === '[]'">
                <el-button type="primary" size="mini" plain :disabled="!scope.row.reportPicture || scope.row.reportPicture === '[]'">
                  <i class="el-icon-picture"></i> ÂõæÁâáÊìç‰Ωú
                </el-button>
                <el-dropdown-menu slot="dropdown">
                  <el-dropdown-item
                    :command="{ action: 'preview', files: scope.row.reportPicture }"
                    :disabled="!scope.row.reportPicture"
                  >È¢ÑËßà</el-dropdown-item>
                  <el-dropdown-item
                    :command="{ action: 'download', files: scope.row.reportPicture }"
                    :disabled="!scope.row.reportPicture"
                  >‰∏ãËΩΩ</el-dropdown-item>
                </el-dropdown-menu>
              </el-dropdown>
            </template>
          </el-table-column>

          <!-- ÂÆ°Ê†∏Áä∂ÊÄÅ -->
          <el-table-column prop="auditStatus" label="ÂÆ°Ê†∏Áä∂ÊÄÅ" width="120" align="center">
            <template v-slot="scope">
              <el-tag
                :type="getStatusTagType(scope.row.auditStatus)"
                effect="light"
                class="status-tag"
              >
                <i :class="getStatusIcon(scope.row.auditStatus)"></i>
                {{ formatAuditStatus(scope.row.auditStatus) }}
              </el-tag>
            </template>
          </el-table-column>
          <el-table-column label="Êìç‰Ωú" width="120" align="center">
            <template v-slot="scope">
              <template v-if="formatAuditStatus(scope.row.auditStatus) === 'Êú™ÈÄöËøá'">
                <el-button
                  type="text"
                  size="mini"
                  @click.stop="handleEdit(scope.row)"
                >ÈáçÊñ∞Êèê‰∫§
                </el-button>
              </template>

              <template v-if="formatAuditStatus(scope.row.auditStatus) === 'Êú™Êèê‰∫§'">
                <el-button
                  type="text"
                  size="mini"
                  @click.stop="handleEdit(scope.row)"
                >ÁºñËæë
                </el-button>
                <el-button
                  type="text"
                  size="mini"
                  style="color: #F56C6C;"
                  @click.stop="handleDelete(scope.row)"
                >Âà†Èô§
                </el-button>
              </template>

              <el-tag
                v-if="['Êú™ÂÆ°Ê†∏', 'Â∑≤ÈÄöËøá'].includes(formatAuditStatus(scope.row.auditStatus))"
                type="info"
                size="mini"
                class="no-edit-tag"
              >‰∏çÂèØ‰øÆÊîπ
              </el-tag>
            </template>
          </el-table-column>
          <!-- ÂÆ°Ê†∏Êó∂Èó¥ -->
          <el-table-column prop="auditTime" label="ÂÆ°Ê†∏Êó∂Èó¥" width="140" align="center">
            <template v-slot="scope">
              <span class="time-display">
                {{ formatDateTime(scope.row.auditTime) }}
              </span>
            </template>
          </el-table-column>

          <!-- ÂÆ°Ê†∏ÊÑèËßÅ -->
          <el-table-column prop="auditRemark" label="ÂÆ°Ê†∏ÊÑèËßÅ" min-width="160" align="center">
            <template v-slot="scope">
              <div class="remark-text">
                {{ scope.row.auditRemark || '-' }}
              </div>
            </template>
          </el-table-column>
        </el-table>

        <!-- Êñ∞Â¢û/ÁºñËæëÂØπËØùÊ°Ü -->
        <el-dialog
          :visible.sync="showDialog"
          :title="isEdit ? 'ÁºñËæëËÆ≤Â∫ßËÆ∞ÂΩï' : 'Êñ∞Â¢ûËÆ≤Â∫ßËÆ∞ÂΩï'"
          class="lecture-dialog"
          width="580px"
          @close="closeCard"
        >
          <div class="dialog-header">
            <h3 class="form-title">{{ isEdit ? 'ÁºñËæëËÆ≤Â∫ßËÆ∞ÂΩï' : 'Êñ∞Â¢ûËÆ≤Â∫ßËÆ∞ÂΩï' }}</h3>
            <p class="form-tips">ËØ∑Â°´ÂÜôÊú¨Â≠¶ÊúüËÆ≤Â∫ßÊåáÂØº‰ø°ÊÅØÔºàÂ∏¶<span class="required">*</span>‰∏∫ÂøÖÂ°´È°πÔºâ</p>
          </div>
          <el-form
            ref="form"
            :model="formData"
            :rules="rules"
            label-width="110px"
            class="lecture-form"
          >
            <!-- ËÆ≤Â∫ßÈ¢òÁõÆ -->
            <el-form-item label="ËÆ≤Â∫ßÈ¢òÁõÆ" prop="reportTitle">
              <el-input
                v-model="formData.reportTitle"
                placeholder="ËØ∑ËæìÂÖ•ËÆ≤Â∫ßÈ¢òÁõÆ"
                class="lecture-input"
              >
                <i slot="prefix" class="el-icon-notebook-2 input-icon"></i>
              </el-input>
            </el-form-item>

            <!-- ËÆ≤Â∏àÂßìÂêç -->
            <el-form-item label="ËÆ≤Â∏àÂßìÂêç" prop="reporter">
              <el-input
                v-model="formData.reporter"
                placeholder="ËØ∑ËæìÂÖ•ËÆ≤Â∏àÂßìÂêç"
                class="lecture-input"
              >
                <i slot="prefix" class="el-icon-s-custom input-icon"></i>
              </el-input>
            </el-form-item>

            <!-- ËÆ≤Â∫ßÂú∞ÁÇπ -->
            <el-form-item label="ËÆ≤Â∫ßÂú∞ÁÇπ" prop="reportLocation">
              <el-input
                v-model="formData.reportLocation"
                placeholder="ËØ∑ËæìÂÖ•ËÆ≤Â∫ßÂú∞ÁÇπ"
                class="location-input"
              >
                <i slot="prefix" class="el-icon-location input-icon"></i>
              </el-input>
            </el-form-item>

            <!-- ËÆ≤Â∫ßÊó•Êúü -->
            <el-form-item label="ËÆ≤Â∫ßÊó•Êúü" prop="reportDate">
              <el-date-picker
                v-model="formData.reportDate"
                type="date"
                value-format="yyyy-MM-dd"
                placeholder="ÈÄâÊã©Êó•Êúü"
                class="time-picker"
                :picker-options="datePickerOptions"
              >
                <i slot="suffix" class="el-icon-date input-icon"></i>
              </el-date-picker>
            </el-form-item>

            <!-- ËÆ≤Â∫ßÈìæÊé• -->
            <el-form-item label="ËÆ≤Â∫ßÈìæÊé•" prop="reportLink">
              <el-input v-model="formData.reportLink" placeholder="ËØ∑ËæìÂÖ•ËÆ≤Â∫ßÈìæÊé•" style="width: 100%;"></el-input>
            </el-form-item>

            <!-- ÊÄªÁªìÊñáÊ°£‰∏ä‰º†ÁªÑ‰ª∂ -->
            <el-form-item label="ÊÄªÁªìÊñáÊ°£" prop="reportFeeling">
              <el-upload
                :auto-upload="false"
                :limit="1"
                :on-change="handleSummaryChange"
                :on-remove="handleSummaryRemove"
                :file-list="reportFeelingList"
                class="enhanced-upload"
              >
                <!-- Ëá™ÂÆö‰πâ‰∏ä‰º†ÊåâÈíÆ -->
                <el-button
                  type="primary"
                  size="small"
                  class="custom-upload-btn"
                >
                  <i class="el-icon-upload"></i>
                  ÈÄâÊã©Êñá‰ª∂
                </el-button>

                <!-- ÊèêÁ§∫‰ø°ÊÅØ -->
                <template #tip>
                  <div class="custom-upload-tip">
                    <i class="el-icon-info"></i>
                    ‰ªÖÊîØÊåÅÂçï‰∏™Êñá‰ª∂‰∏ä‰º†ÔºàÊ†ºÂºèÔºöPDF/DOCXÔºå‚â§5MBÔºâ
                  </div>
                </template>

                <!-- Ëá™ÂÆö‰πâÊñá‰ª∂ÂàóË°® -->
                <template #file="{ file }">
                  <div class="custom-file-item">
                    <div class="file-icon-wrapper">
                      <i class="el-icon-document" :class="getFileIcon(file)"></i>
                    </div>
                    <div class="file-details">
                      <span class="file-name">{{ file.name }}</span>
                      <span class="file-size">{{ formatFileSize(file.size) }}</span>
                    </div>
                    <el-button
                      type="danger"
                      class="delete-btn"
                      icon="el-icon-delete"
                      circle
                      @click.stop="handleSummaryRemove(file)"
                    ></el-button>
                  </div>
                </template>
              </el-upload>
            </el-form-item>

            <!-- Áé∞Âú∫ÂõæÁâá -->
            <el-form-item label="Áé∞Âú∫ÂõæÁâá" prop="reportPicture">
              <el-upload
                multiple
                :limit="5"
                :file-list="fileList"
                :auto-upload="false"
                :on-change="handleFileChange"
                :on-remove="handleFileRemove"
                :on-preview="handlePreviewFile"
                list-type="picture-card"
                class="photo-upload"
              >
                <i class="el-icon-plus"></i>
                <div slot="tip" class="el-upload__tip">ÊîØÊåÅÊúÄÂ§ö5Âº†ÂõæÁâá‰∏ä‰º†ÔºàÊ†ºÂºèÔºöJPG/PNGÔºå‚â§5MBÔºâ</div>
              </el-upload>
            </el-form-item>

            <!-- Êìç‰ΩúÊåâÈíÆ -->
            <el-form-item class="form-actions">
              <el-button
                type="info"
                class="save-btn"
                @click="handleSave"
              >‰øùÂ≠òËçâÁ®ø
              </el-button>
              <el-button type="primary"
                         class="submit-btn"
                         @click="handleSubmit"
              >Ê≠£ÂºèÊèê‰∫§</el-button>
            </el-form-item>
          </el-form>
        </el-dialog>

        <!-- ÂàÜÈ°µÁªÑ‰ª∂ -->
        <pagination
          v-show="totalRecords > 0"
          :total="totalRecords"
          :page.sync="currentPage"
          :limit.sync="pageSize"
          @pagination="listReport"
          class="custom-pagination"
        />
      </div>

      <!-- Áé∞Âú∫ÂõæÁâáÈ¢ÑËßàÂØπËØùÊ°Ü -->
      <el-dialog :visible.sync="previewVisible" title="ÂõæÁâáÈ¢ÑËßà" width="60%">
        <div style="text-align: center; margin-bottom: 20px;">
          <img
            :src="fileList[currentPreviewIndex]"
            style="max-width: 100%; display: block; margin: 0 auto;"
            alt="Áé∞Âú∫ÁÖßÁâáÈ¢ÑËßà"
          />
          <el-button
            icon="el-icon-arrow-left"
            :disabled="currentPreviewIndex === 0"
            @click="currentPreviewIndex--"
          ></el-button>
          <span style="margin: 0 20px;">{{ currentPreviewIndex + 1 }} / {{ fileList.length }}</span>
          <el-button
            icon="el-icon-arrow-right"
            :disabled="currentPreviewIndex === fileList.length - 1"
            @click="currentPreviewIndex++"
          ></el-button>
        </div>

        <div slot="footer">
          <el-button
            type="primary"
            @click="downloadSingleFile(fileList[currentPreviewIndex])"
            style="background-color: #42b983; border-color: #42b983;"
          >
            <i class="el-icon-download"></i> ‰∏ãËΩΩÂΩìÂâçÂõæÁâá
          </el-button>
        </div>
      </el-dialog>
      <!-- ÊñáÊ°£È¢ÑËßàÂØπËØùÊ°Ü -->
      <el-dialog
        :visible.sync="docPreviewVisible"
        title="ÊñáÊ°£È¢ÑËßà"
        width="80%"
        class="native-pdf-preview"
      >
        <div v-if="currentDocument.type === 'pdf'" class="preview-container">
          <iframe
            :src="`${currentDocument.url}#toolbar=0&navpanes=0&scrollbar=0`"
            style="width: 100%; height: 75vh; border: none;"
            @load="disablePdfInteractions"
          ></iframe>
        </div>
        <div v-else-if="currentDocument.type === 'docx'" class="preview-container docx-preview">
          <div v-html="docxContent" class="docx-content"></div>
        </div>
      </el-dialog>
    </div>
  </div>
</template>

<script>
// import VuePdfEmbed from 'vue-pdf-embed/dist/vue2-pdf-embed'
import axios from "axios";
import {addReport, listReport, updateReport, delReport, checkLectureUnique} from "@/api/student/lecture";
import store from "@/store";

export default {
  components: {
    // VuePdfEmbed
  },
  data() {
    return {
      allowedImageTypes: ['image/jpg', 'image/png','image/jpeg'], // ÂÖÅËÆ∏ÁöÑÊñá‰ª∂Á±ªÂûã
      maxImageSize: 5 * 1024 * 1024, // 5MBÈôêÂà∂
      originalFeelingName: '', // ‰øùÂ≠òÂéüÂßãÊñá‰ª∂Âêç
      reportFeelingList: [], // ÊÄªÁªìÊñáÊ°£‰∏ä‰º†ÂàóË°®
      reportFile:'',
      isEdit: false,//Âà§Êñ≠‰øÆÊîπËøòÊòØÊèíÂÖ•
      previewVisible: false,
      fileList: [],
      existingFiles: [],
      currentRecordId: null,
      currentPreviewIndex: 0,
      currentDownloadFile: '',
      dialogVisible: false,
      currentLecturePoster: '',
      baseUrl: process.env.VUE_APP_BASE_API,
      records: [],// Â≠òÂÇ®ÂêéÁ´ØËøîÂõûÁöÑËÆ≤Â∫ßÊä•ÂëäËÆ∞ÂΩïÊï∞ÊçÆ
      queryParams: {}, // Êü•ËØ¢Êù°‰ª∂
      currentPage: 1, // ÂΩìÂâçÈ°µ
      pageSize: 10, // ÊØèÈ°µÊòæÁ§∫ÁöÑÊù°Êï∞
      totalRecords: 0, // ÊÄªËÆ∞ÂΩïÊï∞
      showDialog: false,
      newCardInfo: '',
      uploadMessage: null,
      reportFeeling: null,
      currentImage: '',
      docPreviewVisible: false,
      currentDocument: {
        url: '',
        type: '',
        name: ''
      },
      docxContent: '',
      formData: {
        reportTitle: '',
        reporter: '',
        reportDate: '',
        reportContent: '',
        reportLink: '',
        lecturePoster: '',
        reportPicture: [],
        auditStatus: '',
        reportLocation:'',
        semester: '',
      },
      activeSemester: '', // ÂΩìÂâçÂ≠¶Êúü
      datePickerOptions: {
        disabledDate(time) {
          // Á¶ÅÊ≠¢ÈÄâÊã©‰ªäÂ§©‰πãÂêéÁöÑÊó•Êúü
          return time.getTime() > Date.now();
        }
      },
      rules: {
        reportTitle: [{required: true, message: 'ËÆ≤Â∫ßÈ¢òÁõÆ‰∏ç‰∏∫Á©∫', trigger: 'blur'}],
        reporter: [{required: true, message: 'ËÆ≤Â∏àÂßìÂêç‰∏ç‰∏∫Á©∫', trigger: 'blur'}],
        reportLocation: [{required: true, message: 'ËÆ≤Â∫ßÂú∞ÁÇπ‰∏ç‰∏∫Á©∫', trigger: 'blur'}],
        reportDate: [{required: true, message: 'ËØ∑ÈÄâÊã©ËÆ≤Â∫ßÊó•Êúü', trigger: 'change'}]
      },
    };
  },
  mounted() {
    // Ëé∑ÂèñÂ≠¶ÊúüÊï∞ÊçÆ
    this.activeSemester = this.$route.query.semester || 'Êú™Áü•Â≠¶Êúü';
    this.formData.semester = this.findSemester(this.activeSemester);
    this.listReport();  // Âú®È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÊï∞ÊçÆ
  },
  methods: {
    disablePdfInteractions() {
      const iframe = this.$refs.pdfIframe;
      if (!iframe) return;

      try {
        const iframeDoc = iframe.contentDocument;
        // Á¶ÅÁî®ÊñáÊú¨ÈÄâÊã©
        iframeDoc.body.style.userSelect = 'none';
        // ÁßªÈô§ÊâÄÊúâÁÇπÂáªÂ§ÑÁêÜÂô®
        iframeDoc.querySelectorAll('*').forEach(el => {
          el.onclick = null;
        });
      } catch (e) {
        console.warn('PDFÂÆâÂÖ®Á≠ñÁï•ÈôêÂà∂:', e);
      }
    },
    // Â§ÑÁêÜÊñáÊ°£Êìç‰ΩúÂëΩ‰ª§
    handleDocCommand(command) {
      console.log(command.action)
      try {
        const filePath = command.row.reportFeeling;
        if (!filePath) {
          this.$message.warning('Êó†ÂèØÁî®ÊñáÊ°£');
          return;
        }
        const fileData = {
          url: `${process.env.VUE_APP_BASE_API}/profile/${filePath}`,
          type: this.getFileType(filePath),
          name: filePath.split('/').pop()
        };
        if (command.action === 'preview') {
          this.handleDocumentPreview(fileData);
        } else if (command.action === 'download') {
          this.downloadReportFeeling(command.row);
        }
      } catch (error) {
        this.$message.error(`Êìç‰ΩúÂ§±Ë¥•: ${error.message}`);
      }
    },

    // Â§ÑÁêÜÊñáÊ°£È¢ÑËßà
    async handleDocumentPreview(file) {
      const loading = this.$loading({
        lock: true,
        text: 'Ê≠£Âú®Âä†ËΩΩÊñáÊ°£...',
        spinner: 'el-icon-loading',
      });

      try {
        this.currentDocument = file;
        console.log("current url", this.currentDocument);
        if (file.type === 'pdf') {
          this.docPreviewVisible = true; // Áõ¥Êé•ÊòæÁ§∫iframe
        } else if (file.type === 'docx') {
          const response = await axios.get(file.url, {
            responseType: 'arraybuffer',
            headers: {
              Authorization: `Bearer ${localStorage.getItem('token')}`
            }
          });
          const result = await this.parseDocx(response.data);
          this.docxContent = result.html;
        }
        this.docPreviewVisible = true;
      } catch (error) {
        this.$message.error(`È¢ÑËßàÂ§±Ë¥•: ${error.message}`);
      } finally {
        loading.close();
      }
    },

    // Ëß£ÊûêDOCXÊñá‰ª∂
    async parseDocx(arrayBuffer) {
      try {
        const mammoth = await import('mammoth');
        const result = await mammoth.convertToHtml({arrayBuffer});
        return {html: result.value};
      } catch (error) {
        console.error('DOCXËß£ÊûêÂ§±Ë¥•:', error);
        return {html: '<p>ÊñáÊ°£Ëß£ÊûêÂ§±Ë¥•ÔºåËØ∑‰∏ãËΩΩÂêéÊü•Áúã</p>'};
      }
    },

    // Êñá‰ª∂Á±ªÂûãÂà§Êñ≠
    getFileType(filePath) {
      const extension = filePath.split('.').pop().toLowerCase();
      return {
        pdf: 'pdf',
        docx: 'docx',
        doc: 'doc'
      }[extension] || 'other';
    },
    // Ëé∑ÂèñÊñá‰ª∂ÂõæÊ†áÁ±ªÂûã
    getFileIcon(file) {
      const ext = file.name.split('.').pop().toLowerCase()
      if (ext === 'pdf') return 'pdf'
      if (['doc', 'docx'].includes(ext)) return 'doc'
      return 'default'
    },

    // Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
    formatFileSize(bytes) {
      if (!bytes) return '0 B'
      const units = ['B', 'KB', 'MB', 'GB']
      const exp = Math.floor(Math.log(bytes) / Math.log(1024))
      return `${(bytes / Math.pow(1024, exp)).toFixed(1)} ${units[exp]}`
    },
    // Ë°®Â§¥Ê†∑ÂºèÊñπÊ≥ï
    headerStyle() {
      return {
        backgroundColor: '#f8fafc',
        color: '#2b6cb0',
        fontWeight: '600'
      };
    },

    handlePreview(filePath) {
      try {
        const paths = typeof filePath === 'string'
          ? JSON.parse(filePath)
          : filePath;

        if (paths.length === 0) {
          this.$message.error('È¢ÑËßàÂ§±Ë¥•,ÂΩìÂâçÊ≤°ÊúâÊ∑ªÂä†ËøáÁé∞Âú∫ÂõæÁâá');
        }
        if (paths.length > 0) {
          this.fileList = paths.map(path => this.getFullUrl(path));
          this.currentPreviewIndex = 0;
          this.currentDownloadFile = paths[0];
          this.previewVisible = true;
        }
      } catch (error) {
        this.$message.error('È¢ÑËßàÂ§±Ë¥•ÔºöÊñá‰ª∂Ë∑ØÂæÑÊ†ºÂºè‰∏çÊ≠£Á°Æ');
      }
    },


    //Áé∞Âú∫Êä•ÂëäÂ§öÂº†ÂõæÁâá‰∏ãËΩΩ
    async downloadReportPicture(filePaths) {
      try {
        // Ëß£ÊûêÊñá‰ª∂Ë∑ØÂæÑ
        const paths = typeof filePaths === 'string'
          ? JSON.parse(filePaths)
          : filePaths;
        if (!Array.isArray(paths)) {
          throw new Error("Êó†ÊïàÁöÑÊñá‰ª∂Ë∑ØÂæÑÊ†ºÂºè");
        }
        // Â§ÑÁêÜÂ§ö‰∏™Êñá‰ª∂‰∏ãËΩΩ
        if (paths.length >= 1) {
          this.$confirm(`Êú¨Ê¨°‰∏ãËΩΩÂåÖÂê´${paths.length}‰∏™ÂõæÁâáÔºåÊòØÂê¶ÁªßÁª≠Ôºü`, 'ÊâπÈáè‰∏ãËΩΩÊèêÁ§∫', {
            confirmButtonText: 'Á´ãÂç≥‰∏ãËΩΩ',
            cancelButtonText: 'ÂèñÊ∂à',
            type: 'warning'
          }).then(() => {
            paths.forEach(path => {
              const url = `${process.env.VUE_APP_BASE_API}/profile/${path}`;
              this.downloadSingleFile(url);
            });
          });
        }
      } catch (error) {
        this.$message.error(`‰∏ãËΩΩÂ§±Ë¥•: ${error.message}`);
        console.error("‰∏ãËΩΩÈîôËØØËØ¶ÊÉÖ:", error);
      }
    },
    // ‰∏ãËΩΩÂçï‰∏™Êñá‰ª∂
    async downloadSingleFile(filePath) {
      try {
        const response = await axios.get(
          filePath,
          {
            responseType: 'blob',
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token")
            }
          }
        );
        const url = window.URL.createObjectURL(new Blob([response.data]));
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', this.generateFileName1(filePath));
        document.body.appendChild(link);
        link.click();
        URL.revokeObjectURL(url);
        link.remove();
      } catch (error) {
        this.$message.error(`‰∏ãËΩΩÂ§±Ë¥•: ${error.message}`);
      }
    },
    // ÁªôÁé∞Âú∫Êä•ÂëäÂõæÁâáÁîüÊàêÂ∏¶Êó∂Èó¥Êà≥ÁöÑÊñá‰ª∂Âêç
    generateFileName1(filePath) {
      const originalName = filePath.split('/').pop() || 'Áé∞Âú∫Êä•ÂëäÂõæÁâá';
      const timestamp = new Date().getTime();
      const ext = originalName.split('.').pop() || 'jpg';
      return `${originalName.split('.')[0]}_${timestamp}.${ext}`;
    },

    // Âú®methods‰∏≠Ê∑ªÂä†‰ª•‰∏ãÊñπÊ≥ï
    handleFileCommand(command) {
      console.log(2415346554657);
      console.log(command.files);
      if (command.action === 'preview') {
        this.handlePreview(command.files)
      } else if (command.action === 'download') {
        this.downloadReportPicture(command.files)
      }
    },

    handleFileChange(file, fileList) {
      // È¢ùÂ§ñÂèÇÊï∞Áî®‰∫éÊòæÁ§∫ÈîôËØØÊèêÁ§∫
      const done = (condition, message) => {
        if (!condition) {
          this.$message.error(message)
          // ÁßªÈô§ÈùûÊ≥ïÁöÑÊúÄÂêé‰∏Ä‰∏™Êñá‰ª∂
          const newFiles = fileList.slice(0, fileList.length - 1)
          this.fileList = newFiles.slice(-5)
          return false
        }
        // ‰øùÁïôÂêàÊ≥ïÊñá‰ª∂Âπ∂ÈôêÂà∂ÊúÄÂ§ö5‰∏™
        this.fileList = fileList.slice(-5)
        return true
      }
      console.log("file.raw.type:", file.raw.type)
      // Á±ªÂûãÈ™åËØÅ
      const isValidType = this.allowedImageTypes.includes(file.raw.type)
      if (!isValidType) {
        return done(
          false,
          `‰∏çÊîØÊåÅ ${file.name} ÁöÑÊñá‰ª∂Á±ªÂûãÔºåËØ∑‰∏ä‰º† PNG/JPG Ê†ºÂºèÁöÑÂõæÁâá`
        )
      }

      // Â§ßÂ∞èÈ™åËØÅ
      const isValidSize = file.size <= this.maxImageSize
      if (!isValidSize) {
        return done(false, `Êñá‰ª∂ ${file.name} Ë∂ÖËøá5MBÂ§ßÂ∞èÈôêÂà∂`)
      }

      // Êâ©Â±ïÂêç‰∫åÊ¨°È™åËØÅÔºàÈò≤Ê≠¢‰º™Ë£ÖÊâ©Â±ïÂêçÔºâ
      const fileExt = file.name.split('.').pop().toLowerCase()
      const isValidExt = ['jpg', 'png'].includes(fileExt)
      if (!isValidExt) {
        return done(false, `Êñá‰ª∂ ${file.name} ÁöÑÊâ©Â±ïÂêç‰∏çÂêàÊ≥ï`)
      }
      return done(true); // Êñ∞Â¢ûÊ≠§Ë°å
    },
    // Áä∂ÊÄÅÊ†áÁ≠æÊ†∑Âºè
    getStatusTagType(status) {
      const typeMap = {
        '1': 'success',
        '0': 'warning',
        '2': 'danger',
        '3': 'info'
      }
      return typeMap[status] || 'info'
    },

    // Áä∂ÊÄÅÂõæÊ†á
    getStatusIcon(status) {
      const iconMap = {
        '1': 'el-icon-circle-check',
        '0': 'el-icon-time',
        '2': 'el-icon-circle-close',
        '3': 'el-icon-edit'
      }
      return iconMap[status] || 'el-icon-question'
    },
    formatDate(dateString) {
      if (!dateString) return '-'
      const date = new Date(dateString)
      return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`
    },
    formatDateTime(dateString) {
      if (!dateString) return '-'
      const date = new Date(dateString)
      return `${this.formatDate(dateString)} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`
    },
    async handleSave() {
      this.formData.auditStatus = 3;
      this.submitForm();
    },
    async handleSubmit() {
      this.formData.auditStatus = 0;
      this.submitForm();
    },

    // Âà†Èô§Êú™Êèê‰∫§ËÆ∞ÂΩï
    async handleDelete(row) {
      try {
        await this.$confirm('Á°ÆÂÆöÂà†Èô§ËØ•ËÆ∞ÂΩïÂêóÔºü', 'Âà†Èô§Á°ÆËÆ§', {
          confirmButtonText: 'Á°ÆÂÆö',
          cancelButtonText: 'ÂèñÊ∂à',
          type: 'warning'
        });

        const response = await delReport(row.reportId);
        if (response.code === 200) {
          this.$message.success('Âà†Èô§ÊàêÂäü');
          this.initData();
          // localStorage.removeItem(this.getDraftKey());
        }
      } catch (error) {
        if (error !== 'cancel') {
          this.$message.error(`Âà†Èô§Â§±Ë¥•: ${error.message}`);
        }
      }
    },
// ‰øÆÊîπÂêéÁöÑhandleEditÊñπÊ≥ï
    handleEdit(row) {
      try {
        // ÂàùÂßãÂåñÂü∫Á°ÄË°®ÂçïÊï∞ÊçÆ
        this.formData = {
          reportId: row.reportId,
          reportTitle: row.reportTitle,
          reporter: row.reporter,
          reportDate: row.reportDate,
          reportContent: row.reportContent,
          reportLocation: row.reportLocation,
          reportLink: row.reportLink,
          lecturePoster: row.lecturePoster,
          semester: this.formData.semester,
          auditStatus: row.auditStatus,
          reportFeeling: row.reportFeeling || ''
        };
        this.currentRecordId = row.reportId;
        console.log("this.currentRecordId:"+this.currentRecordId)
        // Â§ÑÁêÜÊÄªÁªìÊñáÊ°£ÂõûÊòæ
        this.reportFeelingList = [];
        this.reportFile=null;
        if (row.reportFeeling) {
          // Â∞ÜÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑË∑ØÂæÑÂ≠óÁ¨¶‰∏≤ËΩ¨Êç¢‰∏∫‰∏ä‰º†ÁªÑ‰ª∂ÈúÄË¶ÅÁöÑÊ†ºÂºè
          const fileName = row.reportFeelingName || this.getFileName(row.reportFeeling);
          this.reportFeelingList = [{
            name: fileName,
            url: this.getFullUrl(row.reportFeeling)
          }];

          // ‰øùÊåÅÂéüÂßãÊñá‰ª∂ÂºïÁî®
          this.reportFeeling = row.reportFeeling;
        }

        //Â∑≤ÊúâÁÖßÁâáÂàóË°®
        this.existingFiles = row.reportPicture;

        // Ëß£ÊûêÂõæÁâáË∑ØÂæÑ
        const paths = typeof row.reportPicture === 'string'
          ? JSON.parse(row.reportPicture)
          : row.reportPicture || [];

        // ÁîüÊàêÁ¨¶ÂêàË¶ÅÊ±ÇÁöÑÊñá‰ª∂ÂàóË°®
        this.fileList = paths.map((path, index) => ({
          uid: `existing-${Date.now()}-${index}`,
          name: path.split('/').pop(),
          url: this.getFullUrl(path),
          status: 'success',
          isOld: true,
          path: path
        }));

        // ÊòæÁ§∫ÂØπËØùÊ°Ü
        this.showDialog = true;
        this.isEdit = true;

        console.log('ÂàùÂßãÂåñÁºñËæëÊï∞ÊçÆ:', {
          formData: this.formData,
          fileList: this.fileList
        });

      } catch (error) {
        console.error('ÁºñËæëÂàùÂßãÂåñÂ§±Ë¥•:', error);
        this.$message.error('Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞');
      }
    },
    // ËæÖÂä©ÊñπÊ≥ïÔºö‰ªéË∑ØÂæÑËé∑ÂèñÊñá‰ª∂Âêç
    getFileName(path) {
      return path.split('/').pop().replace(/\?.*/, '');
    },
// ‰øÆÊ≠£ÂêéÁöÑÊñá‰ª∂Ë∑ØÂæÑÊñπÊ≥ï
    getFullUrl(filePath) {
      // Â§ÑÁêÜÂèØËÉΩÂ≠òÂú®ÁöÑÈáçÂ§çprofileÁõÆÂΩï
      const cleanPath = filePath.replace(/^profile\//, '');
      return `${process.env.VUE_APP_BASE_API}/profile/${cleanPath}`;
    },

// Êñá‰ª∂ÁßªÈô§Â§ÑÁêÜ
    handleFileRemove(file, fileList) {
      // Â¶ÇÊûúÊòØÂ∑≤Â≠òÂú®Êñá‰ª∂ÔºåËÆ∞ÂΩïÈúÄË¶ÅÂà†Èô§
      if(file.isOld) {
        this.$set(file, 'deleteFlag', true)
      }
      this.fileList = fileList
    },
    handlePreviewFile(file) {
      if (file.isOld) {
        window.open(file.url);
      } else {
        const reader = new FileReader();
        reader.onload = (e) => {
          window.open(e.target.result);
        };
        reader.readAsDataURL(file.raw);
      }
    },
// ÂõæÁâáÂéãÁº©ÊñπÊ≥ï
    compressImage(file) {
      return new Promise(resolve => {
        const reader = new FileReader()
        reader.onload = e => {
          const img = new Image()
          img.onload = () => {
            const canvas = document.createElement('canvas')
            // ‰øùÊåÅÂÆΩÈ´òÊØîÂéãÁº©Âà∞800px‰ª•ÂÜÖ
            const MAX_SIZE = 800
            let width = img.width
            let height = img.height

            if (width > height) {
              if (width > MAX_SIZE) {
                height *= MAX_SIZE / width
                width = MAX_SIZE
              }
            } else {
              if (height > MAX_SIZE) {
                width *= MAX_SIZE / height
                height = MAX_SIZE
              }
            }

            canvas.width = width
            canvas.height = height
            const ctx = canvas.getContext('2d')
            ctx.drawImage(img, 0, 0, width, height)

            canvas.toBlob(blob => {
              resolve(new File([blob], file.name, {
                type: 'image/jpeg',
                lastModified: Date.now()
              }))
            }, 'image/jpeg', 0.8)
          }
          img.src = e.target.result
        }
        reader.readAsDataURL(file)
      })
    },
    // ÁîüÊàêÂ∏¶Êó∂Èó¥Êà≥ÁöÑÊñá‰ª∂Âêç
    generateFeelingFileName() {
      const date = new Date().toISOString().slice(0, 10);
      const ext = this.getFeelingFileExtension();
      return `reportFeeling_${date}_${Math.random().toString(36).substr(2, 5)}.${ext}`;
    },

    // Ëé∑ÂèñÊñá‰ª∂Êâ©Â±ïÂêç
    getFeelingFileExtension() {
      if (!this.reportFeeling) return '';
      const match = this.reportFeeling.name.match(/\.([a-zA-Z0-9]+)(\?.*)?$/);
      return match ? match[1].toLowerCase() : '';
    },

    //ÊÄªÁªìÊñáÊ°£‰∏ãËΩΩ
    async downloadReportFeeling(row) {
      try {
        const filePath = row.reportFeeling;
        const fileName = row.reportFeelingName;
        // 1. Ëé∑ÂèñÊñá‰ª∂ÂÜÖÂÆπ
        const response = await fetch(filePath, {
          headers: { Authorization: "Bearer " + localStorage.getItem("token") }
        });
        const blob = await response.blob();
        // 2. ÂàõÂª∫‰∏¥Êó∂ÈìæÊé•
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName; // ÂÖ≥ÈîÆÔºöÁõ¥Êé•‰ΩøÁî®ÂêéÁ´ØËøîÂõûÁöÑÂáÜÁ°ÆÊñá‰ª∂Âêç
        // 3. Ëß¶Âèë‰∏ãËΩΩ
        document.body.appendChild(link);
        link.click();

        // 4. Ê∏ÖÁêÜËµÑÊ∫ê
        setTimeout(() => {
          document.body.removeChild(link);
          URL.revokeObjectURL(link.href);
        }, 100);
      } catch (error) {
        this.$message.error(`‰∏ãËΩΩÂ§±Ë¥•: ${error.message}`);
      }
    },

    //ËΩ¨ÂåñÂ≠¶Êúü
    findSemester(semester) {
      const semesterTrimmed = semester.trim();  // ÂéªÈô§ÂâçÂêéÁ©∫Ê†º
      switch (semester) {
        case 'Â§ß‰∏Ä‰∏ä':
          return 1;
        case 'Â§ß‰∏Ä‰∏ã':
          return 2;
        case 'Â§ß‰∫å‰∏ä':
          return 3;
        case 'Â§ß‰∫å‰∏ã':
          return 4;
        case 'Â§ß‰∏â‰∏ä':
          return 5;
        case 'Â§ß‰∏â‰∏ã':
          return 6;
        case 'Â§ßÂõõ‰∏ä':
          return 7;
        case 'Â§ßÂõõ‰∏ã':
          return 8;
        default:
          return 0;
      }
    },

    // Ê†ºÂºèÂåñÂÆ°Ê†∏Áä∂ÊÄÅ
    formatAuditStatus(status) {
      switch (status) {
        case 0:
          return "Êú™ÂÆ°Ê†∏";
        case 1:
          return "Â∑≤ÈÄöËøá";
        case 2:
          return "Êú™ÈÄöËøá";
        case 3:
          return "Êú™Êèê‰∫§";
        default:
          return "Êú™ÂÆ°Ê†∏";
      }
    },
    addNewCard() {
      this.showDialog = true;
      this.isEdit = false;
      this.currentRecordId = null;
      // ÈáçÁΩÆÊñáÊ°£Áõ∏ÂÖ≥Áä∂ÊÄÅ
      this.reportFeelingList = [];
      this.reportFeeling = null;
    },
    closeCard() {
      this.showDialog = false;
      this.reportFeeling = null;
      this.existingFiles = [];
      this.showDialog = false;
      this.fileList = [];
      this.formData = {
        reportTitle: '',
        reporter: '',
        reportDate: '',
        reportContent: '',
        reportLink: '',
        reportLocation: '',
        lecturePoster: '',
        reportFeeling:'',
        reportFeelingName: '',
        reportPicture: [],
        //ÂÆ°Ê†∏Áä∂ÊÄÅ
        auditStatus: '',
        //Â≠¶Êúü
        semester: this.findSemester(this.activeSemester),
        auditTime: '',
        auditRemark: '',
      };
    },
    // ‰øÆÊîπÂêéÁöÑÊÄªÁªìÊñáÊ°£Â§ÑÁêÜÊñπÊ≥ï
    handleSummaryChange(file, fileList) {
      if (fileList.length > 1) {
        this.$message.warning('Âè™ËÉΩ‰∏ä‰º†‰∏Ä‰∏™Êñá‰ª∂')
        fileList.splice(0, 1)
      }
      // Ê†ºÂºèÈ™åËØÅ
      const allowedTypes = ['application/pdf',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];

      if (!allowedTypes.includes(file.raw.type)) {
        this.$message.error('‰ªÖÊîØÊåÅPDFÂíåDOCXÊ†ºÂºè');
        this.reportFeelingList = []
        this.reportFeeling = null
        this.formData.reportFeeling = ''
        return false;
      }

      // Â§ßÂ∞èÈ™åËØÅÔºà5MBÔºâ
      const maxSize = 5 * 1024 * 1024;
      if (file.size > maxSize) {
        this.$message.error('Êñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá5MB');
        this.reportFeelingList = []
        this.reportFeeling = null
        this.formData.reportFeeling = ''
        return false;
      }
      // ‰øùÂ≠òÂéüÂßãÊñá‰ª∂ÂêçÔºàÊñ∞Â¢ûÔºâ
      this.originalFeelingName = file.name
      // ÂÖ≥ÈîÆ‰øÆÊîπÔºöËé∑ÂèñÂéüÁîüÊñá‰ª∂ÂØπË±°
      this.reportFeelingList = fileList
      this.reportFile=file.raw
      console.log("this.reportFile"+this.reportFile)
    },

    // Êñá‰ª∂ÁßªÈô§ÂõûË∞É
    handleSummaryRemove() {
      this.reportFeelingList = []
      this.reportFeeling = ''
      this.formData.reportFeeling = ''
      this.originalFeelingName = ''//Ê∏ÖÁ©∫Êñá‰ª∂Âêç
    },

    async listReport() {
      this.isLoading = true; // ËÆæÁΩÆ‰∏∫Âä†ËΩΩÁä∂ÊÄÅ
      try {
        const data = await listReport({
          pageNum: this.currentPage,
          pageSize: this.pageSize,
          semester: this.formData.semester,
          studentId: store.state.user.name,
          // ...this.queryParams,
        });
        console.log(data);
        this.records = data.rows || []; // ÂÅáËÆæÂêéÁ´ØËøîÂõûÁöÑÊï∞ÊçÆÊ†ºÂºèÂåÖÂê´ rows
        this.totalRecords = data.total || 0;       // ÂÅáËÆæËøîÂõûÊÄªËÆ∞ÂΩïÊï∞ total
      } catch (error) {
        console.error("Error fetching competition records:", error);
      } finally {
        this.isLoading = false; // Êó†ËÆ∫ÊàêÂäüËøòÊòØÂ§±Ë¥•ÔºåÁªìÊùüÂä†ËΩΩÁä∂ÊÄÅ
      }
    },


    submitForm() {
      this.$refs.form.validate(async (valid) => {
        if (valid) {
          console.log("this.currentRecordId:"+this.currentRecordId)
          console.log(this.records)
          //ÂîØ‰∏ÄÊÄßÊ£ÄÈ™å
          const originalReport = this.records.find(
            item => item.reportId === this.currentRecordId
          );
          console.log('ÂéüÂßãÊï∞ÊçÆ:', originalReport);
          const isKeyFieldChanged = !originalReport ||
            this.formData.reportTitle !== originalReport.reportTitle ||
            this.formData.reportDate !== originalReport.reportDate ||
            this.formData.reporter !== originalReport.reporter ||
            this.formData.reportLocation !== originalReport.reportLocation;

          if (isKeyFieldChanged) {
            try {
              const checkRes = await checkLectureUnique({
                studentId: this.$store.state.user.name,
                reportTitle: this.formData.reportTitle,
                reporter: this.formData.reporter,
                reportDate: this.formData.reportDate,
                reportLocation: this.formData.reportLocation,
                semester: this.findSemester(this.activeSemester)
              });
              if (checkRes.code !== 200) return this.$message.error('Â∑≤Â≠òÂú®Áõ∏ÂêåÊ¥ªÂä®ËÆ∞ÂΩï,‰∏çÂèØÈáçÂ§çÊ∑ªÂä†');
            } catch (error) {
              return this.$message.error(`Ê†°È™åÂ§±Ë¥•: ${error.message}`);
            }
          }


          this.formData.reportFeelingName = this.originalFeelingName
          this.formData.reportFeeling = this.reportFeeling
          console.log('Ë°®ÂçïÊï∞ÊçÆ:', this.formData)
          const formData = new FormData();
          const json = JSON.stringify(this.formData);
          formData.append('studentLectureReport', json);
          formData.append('reportFeeling', this.reportFile);
          console.log('Ë°®ÂçïÊï∞ÊçÆformData.reportFeeling:', this.reportFile);

          // ÊûÑÂª∫Êñá‰ª∂Êï∞ÊçÆ
          const keepFiles = this.fileList
            .filter(file => !file.deleteFlag)
            .map(file => file.isOld ? file.path : file.raw)

          // ÂàÜÁ¶ªÊñ∞ÊóßÊñá‰ª∂
          const oldFiles = keepFiles.filter(f => typeof f === 'string')
          const newFiles = keepFiles.filter(f => f instanceof File)

          // Ê∑ªÂä†Êï∞ÊçÆ
          formData.append('previewImages', JSON.stringify(oldFiles))
          newFiles.forEach(file => {
            formData.append('reportPicture', file)
          })


          console.log('Ë°®ÂçïÊï∞ÊçÆformData.reportPicture:', this.formData.reportPicture);
          console.log('‰º†ÈÄíÂêéÁ´ØÊï∞ÊçÆ:', formData);
          // ÂèØ‰ª•‰ΩøÁî® axios Êàñ fetch ÂèëÈÄÅËØ∑Ê±Ç
          // ‰æãÂ¶ÇÔºö
          if (this.isEdit) {
            //‰øÆÊîπ‰ø°ÊÅØ
            updateReport(formData).then(response => {
              console.log("+++++++++", response);
              this.$message.success('‰øùÂ≠òÊàêÂäü');
              this.initData();
            })
              .catch(error => {
                console.error(error);
                this.initData();
              });
          } else {
            //Á¨¨‰∏ÄÊ¨°Ê∑ªÂä†‰ø°ÊÅØ
            addReport(formData).then(response => {
              console.log("+++++++++", response);
              this.$message.success('Êèê‰∫§ÊàêÂäü');
              this.initData();
            })
              .catch(error => {
                console.error(error);
                this.initData();
              });
          }
        } else {
          this.$message.error('ËØ∑Â°´ÂÜôÂÆåÊï¥Ë°®Âçï‰ø°ÊÅØ');
        }
      });
    },

    initData() {
      this.reportFeeling = null;
      this.existingFiles = [];
      this.showDialog = false;
      this.records = [];
      this.formData = {
        reportTitle: '',
        reporter: '',
        reportDate: '',
        reportContent: '',
        reportLink: '',
        reportLocation: '',
        lecturePoster: '',
        reportPicture: [],
        auditStatus: '',
        semester: this.findSemester(this.activeSemester),
      };
      this.fileList = [];
      this.listReport();  // Âú®È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÊï∞ÊçÆ
    },
  }
};
</script>

<style scoped>
/* ================= ÂÖ®Â±ÄÂÆπÂô®Ê†∑Âºè ================= */
.container {
  display: flex;
  justify-content: center;

  min-height: 100vh;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); /* ÊüîÂíåÁöÑÊ∏êÂèòËÉåÊôØ */
  padding: 20px;
}

.main-container {
  background: #ffffff;
  border-radius: 1.5rem;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  max-width: 1440px;
  overflow: hidden;
  padding: 2rem;
  position: relative;
  width: 100%;
  margin-left: 100px;
}

/* ================= ÂØºËà™Ê†èÊ†∑Âºè ================= */
.nav {
  background: linear-gradient(135deg, #2B6CB0 0%, #4299E1 100%);
  border-radius: 1rem;
  margin: -2rem -2rem 2rem;
  position: relative;
  overflow: hidden;
}

.nav::after {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(45deg,
  rgba(255, 255, 255, 0.1) 25%,
  transparent 50%,
  rgba(255, 255, 255, 0.1) 75%
  );
  opacity: 0.3;
}

.nav-content {
  padding: 1.5rem 2rem;
  position: relative;
  z-index: 1;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.nav h2 {
  color: white;
  font-size: 1.8rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  margin: 0;
}

.score-icon {
  font-size: 1.5em;
  margin-right: 0.5rem;
}

.current-semester {
  font-size: 1.2rem;
  opacity: 0.9;
}

/* ================= Ë°®Ê†ºÊ†∑Âºè ================= */
.report-table-card {
  background: #fff;
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  margin-top: 1.5rem;
}

.optimized-table {
  --table-header-bg: #f8fafc;
  --table-hover-bg: #f7fafc;
  --table-stripe-bg: #f8fafc;
  --table-border-color: #e2e8f0;
  --table-text-primary: #2d3748;
  border-radius: 8px;
  overflow: hidden;
}

/* Ë°®Â§¥Ê†∑Âºè */
.optimized-table /deep/ .el-table__header th {
  background: var(--table-header-bg) !important;
  color: #2b6cb0;
  font-weight: 600;
  font-size: 0.95rem;
}

/* Ë°®Ê†ºË°åÊ†∑Âºè */
.optimized-table /deep/ .el-table__body td {
  color: var(--table-text-primary);
  transition: background 0.2s;
  border-color: var(--table-border-color);
}

.optimized-table /deep/ .el-table__body tr:hover td {
  background: var(--table-hover-bg) !important;
  cursor: pointer;
}

/* ÁâπÊÆäË°åÊ†∑Âºè */
.optimized-table /deep/ .stripe-row td {
  background-color: var(--table-stripe-bg);
}

/* Ë°®Ê†ºÂÖÉÁ¥†Ê†∑Âºè */
.index-badge {
  display: inline-flex;
  width: 28px;
  height: 28px;
  background: #ebf4ff;
  border-radius: 50%;
  align-items: center;
  justify-content: center;
  font-weight: 500;
  color: #2b6cb0;
}
/* ËÆ≤Â∫ßÈ¢òÁõÆÂàó - Êï¥‰ΩìÊ†∑Âºè */
.lecture-name {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 0;
}

/* ÂõæÊ†áÁæéÂåñ */

.name-icon {
  /* Ê†∏ÂøÉÊ†∑Âºè */
  font-size: 18px;
  background: linear-gradient(45deg, #673AB7 30%, #9C27B0 70%); /* Â≠¶ÊúØÁ¥´Ê∏êÂèò */
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent !important;
  filter:
    drop-shadow(0 1px 1px rgba(103,58,183,0.1))
    drop-shadow(0 0 1px rgba(255,255,255,0.5));

  /* Â∏ÉÂ±ÄË∞ÉÊï¥ */
  transform: scale(1.05);
  margin-right: 2px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ÊÇ¨ÂÅú‰∫íÂä®ÊïàÊûú */
.name-icon :hover{
  filter:
    drop-shadow(0 1.5px 2px rgba(126,87,194,0.15))
    drop-shadow(0 0 1.2px rgba(255,255,255,0.8));
  transform: scale(1.1);
}

/* Ê†áÁ≠æÁªü‰∏ÄÊ†∑Âºè */
.level-tag,
.status-tag,
.reporter-tag,
.location-tag{
  border-radius: 12px;
  padding: 0 10px;
  font-weight: 500;
}

.level-tag {
  background: #f0fff4;
  border-color: #c6f6d5;
  color: #38a169;
}
/* ËÆ≤Â∏àÂßìÂêçÊ†áÁ≠æ */
.reporter-tag {
  background: #fff9db;
  border-color: #ffe082;
  color: #b38f00;
}
/* ‰∏ä‰º†ÁªÑ‰ª∂Ê†∑Âºè */
.enhanced-upload {
  width: 100%;
}

/* ‰∏ä‰º†ÊåâÈíÆÊ†∑Âºè */
.custom-upload-btn {
  background: linear-gradient(135deg, #409EFF, #3375ff);
  border: none;
  padding: 10px 20px;
  transition: all 0.3s;

  &:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(64, 158, 255, 0.3);
  }

  i {
    margin-right: 8px;
  }
}

/* ÊèêÁ§∫‰ø°ÊÅØÊ†∑Âºè */
.custom-upload-tip {
  color: #909399;
  font-size: 12px;
  margin-top: 8px;
  display: flex;
  align-items: center;

  .el-icon-info {
    margin-right: 6px;
    font-size: 14px;
  }
}

/* Êñá‰ª∂È°πÊ†∑Âºè */
.custom-file-item {
  display: flex;
  align-items: center;
  padding: 12px;
  margin-top: 10px;
  background: #f8faff;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
  transition: all 0.3s;

  &:hover {
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }
}

.file-icon-wrapper {
  width: 36px;
  height: 36px;
  background: #409EFF10;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;

  .el-icon-document {
    font-size: 20px;

    &.pdf { color: #FF5252; }
    &.doc, &.docx { color: #2B579A; }
    &.default { color: #409EFF; }
  }
}

.file-details {
  flex: 1;
  margin: 0 16px;

  .file-name {
    display: block;
    color: #303133;
    font-weight: 500;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .file-size {
    color: #909399;
    font-size: 12px;
  }
}

.delete-btn {
  opacity: 0.7;
  transition: all 0.3s;

  &:hover {
    opacity: 1;
    transform: scale(1.1);
  }

  /deep/ i {
    vertical-align: baseline;
  }
}
/* Á¶ÅÁî®Áä∂ÊÄÅÁöÑÈìæÊé•Ê†∑Âºè */
.disabled-link {
  color: #c0c4cc !important; /* Element UI Á¶ÅÁî®ÊñáÊú¨Ëâ≤ */
  cursor: not-allowed !important;
  text-decoration: none !important;
  pointer-events: none; /* ÂΩªÂ∫ïÁ¶ÅÁî®‰∫§‰∫í */
  opacity: 0.7; /* Áªü‰∏ÄÈôç‰ΩéÈÄèÊòéÂ∫¶ */
}

/* Á¶ÅÁî®Áä∂ÊÄÅÁöÑÊ†áÁ≠æÂÆπÂô® */
.disabled-tag {
  background-color: #f5f7fa !important; /* Element Á¶ÅÁî®ËÉåÊôØËâ≤ */
  border-color: #e4e7ed !important; /* ËæπÊ°ÜÈ¢úËâ≤‰∏éËÉåÊôØÂçèË∞É */
}

/* Ê≠£Â∏∏Áä∂ÊÄÅÁöÑÈìæÊé•Ê†∑Âºè */
.location-tag .link-style {
  text-decoration: none;
  transition: all 0.2s; /* Ê∑ªÂä†ÊÇ¨ÊµÅÂä®Áîª */
}

/* ÊÇ¨ÂÅúÁä∂ÊÄÅÂ¢ûÂº∫‰ΩìÈ™å */
.location-tag .link-style:hover {
  text-decoration: underline;
  opacity: 0.8;
}
/* Á¶ÅÁî®Áä∂ÊÄÅÊ†∑Âºè */
.document-btn.el-button--primary.is-disabled {
  background-color: #f0f4ff !important;
  border-color: #c6d9ff !important;
  color: #a3c3ff !important;
  cursor: not-allowed;
}
/* ÊÇ¨ÂÅúÁä∂ÊÄÅ‰øùÊåÅÁ¶ÅÁî®Ê†∑Âºè */
.document-btn.el-button--primary.is-disabled:hover {
  background-color: #f0f4ff !important;
  border-color: #c6d9ff !important;
  color: #a3c3ff !important;
}

/* Á¶ÅÁî®ÂõæÊ†áÊ†∑Âºè */
.document-btn.is-disabled .el-icon-download {
  opacity: 0.5;
}

/* ÈìæÊé•Ê†∑Âºè */
.link-style {
  color: #409EFF; /* Element‰∏ªËìùËâ≤ */
  text-decoration: none;
  transition: all 0.3s;
}

.link-style:hover {
  text-decoration: underline;
  color: #79bbff;
}

/* Ë∞ÉÊï¥Ê†áÁ≠æÂÜÖËæπË∑ù */
.location-tag .el-tag__content {
  padding: 2px 6px;
}
/* ================= ÂàÜÈ°µÊ†∑Âºè ================= */
.custom-pagination {
  display: flex;
  justify-content: center !important; /* Âº∫Âà∂Â±Ö‰∏≠ */
  margin: 20px auto 0;
  padding: 12px 0;
  width: 100%;
}

/* Ë∞ÉÊï¥ÂàÜÈ°µÁªÑ‰ª∂ÂÜÖÈÉ®Â∏ÉÂ±Ä */
.custom-pagination /deep/ .el-pagination {
  display: inline-flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 8px;
}

/* ================= ÂØπËØùÊ°ÜÊ†∑Âºè ================= */
.lecture-dialog {
  border-radius: 12px;
}

.lecture-dialog /deep/ .el-dialog__header {
  display: none; /* ÈöêËóèÂéüÁîüÊ†áÈ¢ò */
}

.dialog-header {
  text-align: center;
  padding: 20px 0 15px;
  background: linear-gradient(135deg, #2B6CB0 0%, #4299E1 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* Ë°®ÂçïÂÖÉÁ¥†Ê†∑Âºè */
.lecture-form {
  padding: 0 30px 20px;
}

.input-icon {
  color: #a0aec0;
  margin-left: 8px;
}


.el-upload__tip {
  color: #718096;
  font-size: 0.85rem;
}

/* Êìç‰ΩúÊåâÈíÆ */
.form-actions {
  margin-top: 25px;
  text-align: center;
}

.save-btn {
  background: #edf2f7;
  border-color: #cbd5e0;
  color: #4a5568;
}

.submit-btn {
  background: #48bb78;
  border-color: #48bb78;
}

.submit-btn:hover {
  background: #38a169;
  border-color: #38a169;
}
/* ================= ÂìçÂ∫îÂºèËÆæËÆ° ================= */
@media (max-width: 768px) {
  .container {
    padding: 1rem;
  }

  .nav h2 {
    font-size: 1.4rem;
  }

  .optimized-table /deep/ .el-table__header th {
    font-size: 0.8rem;
  }
}
/* ================= ÊñáÊ°£Ê†∑ÂºèÁæéÂåñ ================= */
.docx-preview {
  /* ÂÆπÂô®Ê†∑Âºè */
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
  padding: 2rem;
  max-height: 70vh;
  overflow-y: auto;

  /* ÊªöÂä®Êù°ÁæéÂåñ */

  &::-webkit-scrollbar {
    width: 8px;
    background: #f5f5f5;
  }

  &::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }

  .docx-content {
    /* Âü∫Á°ÄÊéíÁâà */
    font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
    line-height: 1.8;
    color: #333;
    max-width: 800px;
    margin: 0 auto;

    /* Ê†áÈ¢òÂ±ÇÁ∫ß */

    h1, h2, h3, h4, h5, h6 {
      color: #2c3e50;
      margin: 1.5em 0 1em;
      font-weight: 600;
      position: relative;
      padding-left: 1rem;

      &::before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        height: 60%;
        width: 4px;
        background: #42b983;
      }
    }

    h1 {
      font-size: 24px;
    }

    h2 {
      font-size: 22px;
    }

    h3 {
      font-size: 20px;
    }

    h4 {
      font-size: 18px;
    }

    /* ÊÆµËêΩÊ†∑Âºè */

    p {
      margin: 1em 0;
      text-indent: 2em;
    }

    /* ÂàóË°®Â¢ûÂº∫ */

    ul, ol {
      padding-left: 2em;
      margin: 1em 0;

      li {
        margin: 0.5em 0;
        padding-left: 0.5em;

        &::marker {
          color: #42b983;
        }
      }
    }

    /* Ë°®Ê†ºÁæéÂåñ */

    table {
      width: 100%;
      margin: 1.5em 0;
      border-collapse: collapse;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);

      th {
        background: #f8f9fa;
        padding: 12px;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
      }

      td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
      }

      tr:nth-child(even) {
        background-color: #f8f9fa;
      }
    }

    /* ‰ª£Á†ÅÂùóÊ†∑Âºè */

    pre {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 1rem;
      margin: 1.5em 0;
      overflow-x: auto;

      code {
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        color: #e83e8c;
      }
    }

    /* ÂºïÁî®Ê†∑Âºè */

    blockquote {
      border-left: 4px solid #42b983;
      background: #f8f9fa;
      margin: 1.5em 0;
      padding: 1em 1.5em;
      color: #6c757d;

      p {
        margin: 0;
        text-indent: 0;
      }
    }

    /* ÂõæÁâáÈÄÇÈÖç */

    img {
      max-width: 80%;
      height: auto;
      display: block;
      margin: 1.5em auto;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* È°µÁúâÈ°µËÑöÈöêËóè */

    .Header, .Footer {
      display: none;
    }
  }
}

</style>
